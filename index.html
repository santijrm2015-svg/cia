<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="icono.png" type="x-png">
    <title>CIA Secret</title>
    <style>
        body { background-color: #000000; font-family: 'Lucida Console', 'Courier New', monospace; margin: 0; padding: 0; height: 100dvh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        #loginScreen { text-align: center; color: #AAAAAA; padding: 20px; background: rgba(13, 17, 23, 0.8); border: 1px solid #30363d; border-radius: 8px; box-shadow: 0 0 20px rgba(48, 54, 61, 0.5); width: 90%; max-width: 400px; }
        #loginScreen h1 { color: #f0f6fc; font-weight: 300; letter-spacing: 2px; margin-bottom: 20px; font-size: 1.5em; }
        #loginScreen p { margin-bottom: 20px; font-size: 0.9em; }
        #loginScreen input { width: 100%; padding: 10px; margin-bottom: 20px; background: #222; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box; }
        #loginScreen button { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 16px; }
        #loginScreen button:hover { background-color: #0056b3; }
        
        #consoleContainer { width: 100%; height: 100dvh; display: none; flex-direction: row; }
        #chatSidebar { width: 250px; background-color: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #newChatBtn { background-color: #2c3e50; color: white; border: none; padding: 12px; margin: 10px; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: 14px; }
        #newChatBtn:hover { background-color: #34495e; }
        #chatList { flex-grow: 1; overflow-y: auto; list-style-type: none; padding: 0; margin: 0; }
        .chat-item { padding: 12px 15px; color: #b0b0b0; cursor: pointer; border-bottom: 1px solid #2a2a2a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item:hover { background-color: #2a2a2a; }
        .chat-item.active { background-color: #007bff; color: white; }
        .chat-item .chat-title { font-weight: bold; }
        .chat-item .chat-date { font-size: 11px; color: #888; }

        #mainContent { flex-grow: 1; display: flex; flex-direction: column; }
        .profile-bar { background-color: #1a1a1a; color: #AAAAAA; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        .profile-info { display: flex; align-items: center; overflow: hidden; }
        .profile-info img { width: 24px; height: 24px; border-radius: 50%; margin-right: 10px; border: 1px solid #555; flex-shrink: 0; }
        .profile-info span { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .logout-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; flex-shrink: 0; }
        .logout-btn:hover { background-color: #c82333; }
        #console { flex-grow: 1; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; padding: 10px; background: #000000; color: #AAAAAA; font-family: 'Lucida Console', 'Courier New', monospace; font-size: 14px; }
        .input-line { display: flex; align-items: center; }
        .prompt { margin-right: 8px; color: #FFFFFF; font-weight: bold; flex-shrink: 0; }
        #userInput { background: none; border: none; color: inherit; font-family: inherit; font-size: inherit; outline: none; flex-grow: 1; }
        .cursor { display: inline-block; width: 8px; height: 14px; background-color: #FFFFFF; animation: blink 1s step-end infinite; margin-left: 2px; flex-shrink: 0; }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: #FFFFFF; } }
        #console::-webkit-scrollbar, #chatList::-webkit-scrollbar { width: 8px; }
        #console::-webkit-scrollbar-track, #chatList::-webkit-scrollbar-track { background: #1a2332; }
        #console::-webkit-scrollbar-thumb, #chatList::-webkit-scrollbar-thumb { background: #2f3f52; }
        #console::-webkit-scrollbar-thumb:hover, #chatList::-webkit-scrollbar-thumb:hover { background: #4a5f7a; }
        .ai-response { color: #AAAAAA; }
        .error-message { color: #ff4757; }
        .system-message { color: #ffa502; }
        .audit-report { color: #e74c3c; border-left: 3px solid #e74c3c; padding-left: 10px; margin-top: 10px; }
        .clone-report { color: #9b59b6; border-left: 3px solid #9b59b6; padding-left: 10px; margin-top: 10px; white-space: pre-wrap;}
        .recon-report { color: #3498db; border-left: 3px solid #3498db; padding-left: 10px; margin-top: 10px;}
        .history-message { color: #6c757d; font-style: italic; }
        .finding-critical { color: #c0392b; }
        .finding-high { color: #e74c3c; }
        .finding-medium { color: #f39c12; }
        .finding-low { color: #f1c40f; }
        .finding-info { color: #95a5a6; }
        @media (min-width: 768px) { #loginScreen { max-width: 500px; } #console { font-size: 15px; padding: 15px; } .profile-info span { font-size: 14px; } .cursor { width: 10px; height: 18px; } }
        @media (min-width: 1024px) { #loginScreen { max-width: 550px; } #console { font-size: 16px; } .profile-info span { font-size: 15px; } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="loginScreen">
        <h1>CIA SECRETA</h1>
        <p>Introduce un nombre de usuario para acceder a la consola.</p>
        <form id="loginForm">
            <input type="text" id="usernameInput" placeholder="Tu nombre de agente" required>
            <button type="submit">ENTRAR</button>
        </form>
    </div>

    <div id="consoleContainer">
        <div id="chatSidebar">
            <button id="newChatBtn">+ Nuevo Chat</button>
            <ul id="chatList"></ul>
        </div>
        <div id="mainContent">
            <div class="profile-bar">
                <div class="profile-info">
                    <img src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="Profile">
                    <span id="profileName">Agente</span>
                </div>
                <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
            </div>
            <div id="console"></div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyACZbGOB0wLkKKaVrcUp88rklLGR-atXpM",
            authDomain: "ciaproyect-86a79.firebaseapp.com",
            databaseURL: "https://ciaproyect-86a79-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ciaproyect-86a79",
            storageBucket: "ciaproyect-86a79.firebasestorage.app",
            messagingSenderId: "121043448227",
            appId: "1:121043448227:web:c1223eb67aaf018a24aa16",
            measurementId: "G-YYDFQGEXD7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const GROQ_API_KEY = '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';
        
        let currentUser = null;
        let currentChatId = null;
        let allChats = [];
        let isAiMode = false; // --- NUEVO: Estado para el modo IA ---

        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('usernameInput').value.trim();
            if (username) {
                currentUser = { name: username, uid: username.toLowerCase().replace(/\s+/g, '_') };
                localStorage.setItem('sigiloUser', JSON.stringify(currentUser));
                showConsole();
            }
        });

        function logout() {
            localStorage.removeItem('sigiloUser');
            currentUser = null; currentChatId = null; allChats = []; isAiMode = false;
            document.getElementById('consoleContainer').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('console').innerHTML = '';
        }

        function showConsole() {
            if (!currentUser) return;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('consoleContainer').style.display = 'flex';
            document.getElementById('profileName').textContent = currentUser.name;
            initializeConsole();
        }

        function initializeConsole() {
            const bootMessages = [
                `CIA SECRETA - Terminal de Acceso Remoto v2.6`,
                `Usuario conectado: ${currentUser.name}`,
                'Sincronizando sesiones de chat...',
                'Terminal listo.'
            ];
            let i = 0;
            const bootInterval = setInterval(() => {
                if (i < bootMessages.length) {
                    addLine(bootMessages[i], 'system-message');
                    i++;
                } else {
                    clearInterval(bootInterval);
                    loadChatList().then(() => {
                        const mostRecentChat = allChats.sort((a, b) => b.updatedAt.toDate() - a.updatedAt.toDate())[0];
                        if (mostRecentChat) {
                            loadChat(mostRecentChat.id);
                        } else {
                            startNewChatSession();
                        }
                    });
                }
            }, 400);
        }
        
        async function saveLogToFirestore(command, output, type = 'command', chatId = null) {
            if (!currentUser || !currentUser.uid) return;
            try {
                await db.collection('logs').add({
                    userId: currentUser.uid,
                    chatId: chatId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    command: command,
                    output: output,
                    type: type
                });
                console.log("Log guardado en Firestore.");
            } catch (error) { console.error("Error al guardar log en Firestore:", error); }
        }
        
        async function loadChatList() {
            if (!currentUser) return;
            const chatListEl = document.getElementById('chatList');
            chatListEl.innerHTML = '';
            allChats = [];
            const snapshot = await db.collection('chats').where('userId', '==', currentUser.uid).orderBy('updatedAt', 'desc').get();
            snapshot.forEach(doc => {
                allChats.push({ id: doc.id, ...doc.data() });
            });
            renderChatList();
        }

        function renderChatList() {
            const chatListEl = document.getElementById('chatList');
            chatListEl.innerHTML = '';
            allChats.forEach(chat => {
                const li = document.createElement('li');
                li.className = 'chat-item';
                if (chat.id === currentChatId) li.classList.add('active');
                li.innerHTML = `
                    <div class="chat-title">${chat.title || 'Nueva Sesión'}</div>
                    <div class="chat-date">${new Date(chat.updatedAt.toDate()).toLocaleString()}</div>
                `;
                li.onclick = () => loadChat(chat.id);
                chatListEl.appendChild(li);
            });
        }
        
        async function startNewChatSession() {
            currentChatId = null;
            isAiMode = false; // --- NUEVO: Resetear modo IA ---
            document.getElementById('console').innerHTML = '';
            addLine('Nueva sesión de terminal iniciada. Escribe "help" para ver los comandos disponibles.', 'system-message');
            createInputLine('C:\\>'); // --- NUEVO: Prompt normal ---
            renderChatList();
        }
        
        async function createNewChat(firstMessage) {
            const newChatRef = await db.collection('chats').add({
                userId: currentUser.uid,
                title: firstMessage.substring(0, 50) + (firstMessage.length > 50 ? '...' : ''),
                createdAt:firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            currentChatId = newChatRef.id;
            allChats.unshift({ id: newChatRef.id, title: firstMessage.substring(0, 50) + '...', userId: currentUser.uid, updatedAt: new Date() });
            renderChatList();
            return newChatRef.id;
        }

        async function loadChat(chatId) {
            currentChatId = chatId;
            isAiMode = false; // --- NUEVO: Resetear modo IA al cargar chat ---
            document.getElementById('console').innerHTML = '';
            addLine(`Cargando sesión: ${allChats.find(c => c.id === chatId)?.title}`, 'system-message');
            const snapshot = await db.collection('logs').where('chatId', '==', chatId).orderBy('timestamp', 'asc').get();
            snapshot.forEach(doc => {
                const log = doc.data();
                if (log.type === 'ai_response') {
                    addLine(log.output, 'ai-response');
                } else {
                    addLine(`> ${log.command}`, 'history-message');
                }
            });
            addLine('--- Historial cargado ---', 'system-message');
            createInputLine('C:\\>'); // --- NUEVO: Prompt normal ---
            renderChatList();
        }
        
        function addLine(text, className = '') { const line = document.createElement('div'); line.className = className; line.innerHTML = text; document.getElementById('console').appendChild(line); document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight; }
        
        // --- MODIFICADO: createInputLine ahora acepta el texto del prompt ---
        function createInputLine(promptText) {
            // Eliminar la línea de entrada anterior si existe
            const existingInput = document.querySelector('.input-line');
            if (existingInput) {
                existingInput.remove();
            }

            const inputLine = document.createElement('div');
            inputLine.className = 'input-line';
            const prompt = document.createElement('span');
            prompt.className = 'prompt';
            prompt.textContent = promptText;
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'userInput';
            input.autocapitalize = 'off';
            input.autocomplete = 'off';
            input.spellcheck = 'false';
            const cursor = document.createElement('span');
            cursor.className = 'cursor';
            inputLine.appendChild(prompt);
            inputLine.appendChild(input);
            inputLine.appendChild(cursor);
            document.getElementById('console').appendChild(inputLine);
            input.focus();
            input.addEventListener('keydown', handleInput);
        }
        
        // --- MODIFICADO: Manejador principal con lógica de modos ---
        function handleInput(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const fullCommand = input.value.trim();
                const previousLine = input.parentElement;
                previousLine.innerHTML = previousLine.innerHTML.replace('<input type="text" id="userInput">', fullCommand);
                
                if (isAiMode) {
                    // En modo IA, todo se envía a la IA
                    handleGroqCommand(fullCommand);
                } else {
                    // En modo normal, procesamos comandos del terminal
                    const parts = fullCommand.split(' ');
                    const command = parts[0].toLowerCase();
                    const args = parts.slice(1).join(' ');
                    executeCliCommand(command, args, fullCommand);
                }
            }
        }

        // --- MODIFICADO: Ejecutor de comandos CLI ---
        async function executeCliCommand(command, args, fullCommand) {
            let output = '';
            switch (command) {
                case 'help':
                    output = `Comandos disponibles:<br>  help       - Muestra esta ayuda.<br>  ping       - Comprueba la conectividad con un host.<br>  ipconfig   - Muestra la configuración de red.<br>  dir        - Lista archivos y directorios.<br>  whoami     - Muestra el usuario actual.<br>  clear      - Limpia la pantalla.<br>  ai         - Pregunta a la IA (uso: ai "tu pregunta").<br>  cmd        - Entra/Sale del modo IA.<br>  auditar    - Realiza una auditoría profunda a una URL.<br>  revisar    - Extrae enlaces y recursos de una URL.<br>  clonar    - Genera una copia HTML de una URL.<br>  exit       - Cierra la sesión.`;
                    break;
                case 'ping':
                    output = await handlePing(args);
                    break;
                case 'ipconfig':
                    output = await handleIpconfig();
                    break;
                case 'dir':
                    output = handleDir();
                    break;
                case 'whoami':
                    output = handleWhoami();
                    break;
                case 'clear':
                    document.getElementById('console').innerHTML = '';
                    createInputLine('C:\\>');
                    return;
                case 'ai':
                    if (args) {
                        handleGroqCommand(args);
                        return;
                    } else {
                        output = "Uso: ai \"tu pregunta a la IA\"";
                    }
                    break;
                case 'cmd':
                    toggleAiMode();
                    return;
                case 'auditar':
                    await handleAuditCommand(args);
                    return;
                case 'revisar':
                    await handleRevisarCommand(args);
                    return;
                case 'clonar':
                    handleClonarCommand(args);
                    return;
                case 'exit':
                    logout();
                    return;
                default:
                    output = `'${command}' no se reconoce como un comando interno o externo.<br>Escriba 'help' para ver los comandos disponibles.`;
                    break;
            }
            addLine(output, 'ai-response');
            if (!currentChatId) {
                await createNewChat(fullCommand);
            }
            saveLogToFirestore(fullCommand, output, 'cli-command', currentChatId);
            createInputLine('C:\\>');
        }
        
        // --- NUEVO: Función para cambiar entre modos ---
        function toggleAiMode() {
            isAiMode = !isAiMode;
            if (isAiMode) {
                addLine('Entrando en Modo IA. Escribe tus preguntas directamente.', 'system-message');
                addLine('Escribe "cmd" de nuevo para salir del Modo IA.', 'system-message');
                createInputLine('AI:\\>'); // --- NUEVO: Prompt de IA ---
            } else {
                addLine('Saliendo del Modo IA. Volviendo al terminal.', 'system-message');
                createInputLine('C:\\>'); // --- NUEVO: Prompt normal ---
            }
        }

        // --- SIMULACIONES DE COMANDOS (sin cambios) ---
        async function handlePing(args) { if (!args[0]) return "Uso: ping <hostname_o_url>"; const host = args[0]; addLine(`Haciendo ping a ${host} con 32 bytes de datos:`, 'system-message'); try { const startTime = performance.now(); const response = await fetch(`https://cors-anywhere.herokuapp.com/${host}`); const endTime = performance.now(); const time = Math.round(endTime - startTime); if (response.ok) { return `Respuesta de ${host}: bytes=32 tiempo=${time}ms TTL=54`; } else { return `Error de red: El host ${host} no es accesible.`; } } catch (error) { return `Error de red: No se pudo resolver el nombre del host ${host}.`; } }
        async function handleIpconfig() { try { const response = await fetch('https://api.ipify.org?format=json'); const data = await response.json(); const publicIp = data.ip; const localIp = `192.168.1.${Math.floor(Math.random() * 255) + 1}`; return `Configuración IP de Windows<br><br>Adaptador de Ethernet Conexión de área local:<br><br>   Sufijo DNS principal . : <br>   IPv4. Dirección IP. . . . . : ${publicIp}<br>   Máscara de subred . . . . : 255.255.255.0<br>   Puerta de enlace predeterminada . : 192.168.1.1<br><br>Adaptador de Ethernet Conexión inalámbrica:<br><br>   Sufijo DNS principal . : <br>   IPv4. Dirección IP. . . . . : ${localIp}<br>   Máscara de subred . . . . : 255.255.255.0<br>   Puerta de enlace predeterminada . : 192.168.1.1`; } catch (error) { return "Error: No se pudo obtener la configuración de red."; } }
        function handleDir() { const files = ['agent_logs.txt', 'mission_plan.docx', 'report_final.pdf', 'photo_evidence.jpg', 'toolkit.exe', 'readme.md']; const dirs = ['Archivos de programa', 'Usuarios', 'Documentos', 'Descargas']; let output = ` El volumen en la unidad C no tiene etiqueta.<br> El número de serie del volumen es 1234-ABCD<br><br> Directorio de C:\\<br>${new Date().toLocaleDateString()}  ${new Date().toLocaleTimeString()}<br><br>`; dirs.forEach(dir => output += `    ${dir}/<br>`); files.forEach(file => output += `    ${file}<br>`); output += `        10 Archivos(s) ${dirs.length} Dir(s)<br> 15,234,567,890 bytes libres`; return output; }
        function handleWhoami() { return `cia-secreta\\${currentUser.uid}`; }

        // --- COMANDOS EXISTENTES (sin cambios, pero ahora se guardan correctamente) ---
        async function handleAuditCommand(url) {
            if (!url) { addLine('Uso: auditar <URL>', 'error-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>'); return; }
            let targetUrl; try { targetUrl = new URL(url); } catch (error) { addLine(`ERROR: URL inválida.`, 'error-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>'); return; }
            addLine(`[AUDITORÍA PROFUNDA] -> ${targetUrl.href}`, 'system-message'); addLine('Conectando y extrayendo datos...', 'system-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>');
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; const fetchUrl = proxyUrl + targetUrl.href;
            try {
                const response = await fetch(fetchUrl); const htmlText = await response.text(); const parser = new DOMParser(); const doc = parser.parseFromString(htmlText, 'text/html');
                let reportHtml = `<strong>--- INFORME DE AUDITORÍA (REAL) ---</strong><br><br>Objetivo: ${targetUrl.href}<br>Fecha: ${new Date().toISOString()}<br><br><strong>1. Información del Servidor</strong><br>- Estado HTTP: <span class="finding-info">${response.status} ${response.statusText}</span><br>- Servidor: <span class="finding-info">${response.headers.get('Server') || 'No especificado'}</span><br>- Powered By: <span class="finding-info">${response.headers.get('X-Powered-By') || 'No especificado'}</span><br>- HSTS: <span class="${response.headers.get('Strict-Transport-Security') ? 'finding-medium' : 'finding-high'}">${response.headers.get('Strict-Transport-Security') ? 'Presente' : 'AUSENTE'}</span><br><br><strong>2. Tecnologías Detectadas</strong><br>- Título: <span class="finding-info">${doc.title || 'Sin título'}</span><br>`;
                const techStack = new Set(); if (htmlText.includes('wp-content')) techStack.add('WordPress'); if (htmlText.includes('jquery')) techStack.add('jQuery'); if (htmlText.includes('react')) techStack.add('React'); if (htmlText.includes('vue')) techStack.add('Vue.js');
                reportHtml += `- Stack: <span class="finding-info">${[...techStack].join(', ') || 'Ninguna conocida'}</span><br><br><strong>3. Escaneo de Rutas</strong><br>`;
                const pathsToCheck = ['/admin', '/wp-admin', '/phpmyadmin', '/.env', '/robots.txt']; const checkPromises = pathsToCheck.map(path => fetch(proxyUrl + targetUrl.origin + path, { method: 'HEAD' }).then(r => ({path, status: r.status})).catch(() => ({path, status: 'ERROR'})));
                const pathResults = await Promise.allSettled(checkPromises); pathResults.forEach(r => { if (r.status === 'fulfilled') { const {path, status} = r.value; let statusText = `${status} ${status === 200 ? 'OK' : status === 403 ? 'Forbidden' : status === 404 ? 'Not Found' : status}`; let className = 'finding-info'; if (status === 200) className = 'finding-critical'; if (status === 403) className = 'finding-high'; reportHtml += `- <span class="${className}">[${statusText}] ${targetUrl.origin}${path}</span><br>`; } });
                reportHtml += `<br><strong>Recomendación:</strong><br>Revise los hallazgos marcados como CRÍTICO o ALTO.`;
                const reportDiv = document.createElement('div'); reportDiv.className = 'audit-report'; reportDiv.innerHTML = reportHtml; document.getElementById('console').appendChild(reportDiv); document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
                if (!currentChatId) { await createNewChat(`auditar ${url}`); } saveLogToFirestore(`auditar ${url}`, reportDiv.innerHTML, 'audit', currentChatId);
            } catch (error) { console.error('Error:', error); addLine(`ERROR DE AUDITORÍA: ${error.message}`, 'error-message'); }
            createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>');
        }

        async function handleRevisarCommand(url) {
            if (!url) { addLine('Uso: revisar <URL>', 'error-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>'); return; }
            let targetUrl; try { targetUrl = new URL(url); } catch (error) { addLine(`ERROR: URL inválida.`, 'error-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>'); return; }
            addLine(`[RECONOCIMIENTO ACTIVO] -> ${url}`, 'system-message'); addLine('Analizando contenido...', 'system-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>');
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; const fetchUrl = proxyUrl + targetUrl.href;
            try {
                const response = await fetch(fetchUrl); if (!response.ok) throw new Error(`Error ${response.status}`); const htmlText = await response.text(); const parser = new DOMParser(); const doc = parser.parseFromString(htmlText, 'text/html');
                const links = Array.from(doc.querySelectorAll('a[href]')).map(a => a.href); const resources = Array.from(doc.querySelectorAll('link[href], script[src], img[src]')).map(el => el.href || el.src); const allUrls = [...new Set([...links, ...resources])];
                const reportDiv = document.createElement('div'); reportDiv.className = 'recon-report'; let reportHtml = `<strong>--- INFORME DE RECONOCIMIENTO (REAL) ---</strong><br><br>Objetivo: ${targetUrl.href}<br>Título: ${doc.title || 'N/A'}<br><strong>Recursos (${allUrls.length}):</strong><br>`; allUrls.slice(0, 50).forEach(u => { reportHtml += `- ${u}<br>`; });
                reportDiv.innerHTML = reportHtml; document.getElementById('console').appendChild(reportDiv); document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
                if (!currentChatId) { await createNewChat(`revisar ${url}`); } saveLogToFirestore(`revisar ${url}`, reportDiv.innerHTML, 'revisar', currentChatId);
            } catch (error) { console.error('Error:', error); addLine(`ERROR DE RECONOCIMIENTO: ${error.message}`, 'error-message'); }
            createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>');
        }

        function handleClonarCommand(url) {
            if (!url) { addLine('Uso: clonar <URL>', 'error-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>'); return; }
            addLine(`[CLONACIÓN / ARCHIVO] -> ${url}`, 'system-message'); addLine('Generando copia...', 'system-message'); createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>');
            setTimeout(() => { try { const domain = new URL(url).hostname; const simulatedHtml = generateClonedHtml(url, domain); const reportDiv = document.createElement('div'); reportDiv.className = 'clone-report'; reportDiv.innerHTML = `<strong>--- CONTENIDO CLONADO (HTML) ---</strong><br><br><strong>ADVERTENCIA:</strong> Este contenido es para archivo o análisis offline.<br><br><pre>${simulatedHtml}</pre>`; document.getElementById('console').appendChild(reportDiv); document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight; if (!currentChatId) { createNewChat(`clonar ${url}`); } saveLogToFirestore(`clonar ${url}`, reportDiv.innerHTML, 'clonar', currentChatId); } catch (error) { addLine(`ERROR: No se pudo clonar la URL.`, 'error-message'); } createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>'); }, 2000);
        }
        function generateClonedHtml(url, domain) { return `<!DOCTYPE html>\n<html lang="es">\n<head>\n    <meta charset="UTF-8">\n    <title>Clonado de ${url}</title>\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <style>\n        body { font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; padding: 20px; }\n        h1 { color: #0056b3; }\n        p { line-height: 1.6; }\n    </style>\n</head>\n<body>\n    <h1>Archivo de ${domain}</h1>\n    <p>Esta página ha sido clonada para fines de archivo o análisis offline.</p>\n    <p><strong>URL Original:</strong> <a href="${url}">${url}</a></p>\n    <p><strong>Fecha de Clonación:</strong> ${new Date().toISOString()}</p>\n    <hr>\n    <p>El contenido real de esta página se obtendría mediante una solicitud del lado del servidor en una aplicación real. Esto es una simulación.</p>\n</body>\n</html>`; }
        
        // --- MODIFICADO: handleGroqCommand ahora maneja el guardado del chat ---
        async function handleGroqCommand(query) {
            if (!query) { createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>'); return; }
            if (!isAiMode) { addLine(`[IA ANALYZING] -> ${query}`, 'system-message'); }
            let responseLine = document.createElement('div'); responseLine.className = 'ai-response'; document.getElementById('console').appendChild(responseLine); let fullAiResponse = "";
            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` }, body: JSON.stringify({ messages: [{ role: "user", content: query }], model: "llama-3.3-70b-versatile", temperature: 1, max_tokens: 1024, top_p: 1, stream: true, stop: null }), });
                if (!response.ok) { throw new Error(`Error ${response.status}`); }
                const reader = response.body.getReader(); const decoder = new TextDecoder();
                while (true) { const { done, value } = await reader.read(); if (done) break; const chunk = decoder.decode(value); const lines = chunk.split('\n'); for (const line of lines) { if (line.startsWith('data: ')) { const data = line.slice(6); if (data === '[DONE]') continue; try { const json = JSON.parse(data); const content = json.choices[0].delta.content || ""; if (content) { responseLine.textContent += content; fullAiResponse += content; document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight; } } catch (e) {} } } }
                if (!currentChatId) { await createNewChat(query); }
                saveLogToFirestore(query, fullAiResponse, 'ai_response', currentChatId);
            } catch (error) { console.error("Error al contactar Groq:", error); responseLine.textContent = error.message; responseLine.className = 'error-message'; }
            createInputLine(isAiMode ? 'AI:\\>' : 'C:\\>');
        }

        document.getElementById('newChatBtn').addEventListener('click', startNewChatSession);

        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('sigiloUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showConsole();
            }
        });
    </script>
</body>
</html>
